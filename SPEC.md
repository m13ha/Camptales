# BedTales: Project & AI Services Specification

## 1. Project Description

**BedTales** is an AI-powered storytelling application designed to spark imagination and create magical bedtime moments for children and families. It empowers users to generate unique, beautifully illustrated stories from simple text or voice prompts.

The application is built as a responsive, offline-first Progressive Web App (PWA) that provides a seamless experience across mobile, tablet, and desktop devices.

### Core Features:

- **AI Story Generation:** Users provide a character, setting, plot, and a moral concept. The app uses AI to generate a complete, multi-part story with a title.
- **AI Illustration:** Each paragraph of the story is accompanied by a unique, AI-generated illustration that matches the narrative.
- **Character Creation & Management:** Users can create and save characters with AI-generated portraits. These saved characters can then be easily used in new story prompts.
- **Voice-to-Prompt:** The application leverages speech-to-text and AI structuring to allow users to describe a character or story idea with their voice, which is then automatically parsed into the required input fields.
- **Library & History:** All generated stories can be saved to a personal library. A history of read stories is also maintained for easy access.
- **Customization:** The app's appearance is highly customizable, with multiple themes, font styles, and story reading layouts.
- **Data Portability & Sharing:**
  - **Backup & Restore:** Users can export their entire app data—including all saved stories, characters, history, and application settings—into a single, comprehensive JSON file. This backup can be used to restore their complete state on a new device or after reinstalling the app.
  - **Story Import/Export:** Individual stories or a selection of stories can be exported as a JSON file. This makes it easy for users to share specific creations with friends, who can then import them directly into their own BedTales library.

---

## 2. AI Services Overview

The application utilizes several models from the Google Gemini API to handle text generation, image creation, and audio processing.

### Service: Generate Story Title

- **Purpose:** Creates a short, catchy title for a story based on the user's prompt.
- **File:** `src/services/geminiService.ts`
- **Function:** `generateTitle()`
- **Model:** `gemini-2.5-flash`
- **Prompt:** A template that asks for a creative title under 10 words based on the provided character, setting, plot, and concept.
- **Output:** Plain text string.
- **Configuration:** None.

### Service: Brainstorm Story Ideas

- **Purpose:** Generates a complete `UserPrompt` object (character, setting, plot, concept) to inspire the user.
- **File:** `src/services/geminiService.ts`
- **Function:** `generateStoryIdeas()`
- **Model:** `gemini-2.5-flash`
- **Prompt:** Asks for a whimsical bedtime story idea, optionally focusing on a specific theme (e.g., "Friendship," "Honesty").
- **Output:** A structured JSON object.
- **Configuration:**
  - `responseMimeType: 'application/json'`
  - `responseSchema`: An object schema enforcing the structure `{ character: string, setting: string, plot: string, concept: string }`.

### Service: Generate Story Text & Image Prompts

- **Purpose:** This is the core story generation step. It creates the narrative (broken into 3 paragraphs) and writes detailed, descriptive prompts for the image generation model. It can optionally use a reference image of a character to maintain visual consistency.
- **File:** `src/services/geminiService.ts`
- **Function:** `generateStoryAndImages()` (first part)
- **Model:** `gemini-2.5-flash`
- **Prompt:** A detailed multi-modal prompt that instructs the AI to create a 3-paragraph story based on the user's inputs and to generate a detailed image prompt for each paragraph. If a character image is provided, it is included in the prompt with instructions to keep the generated character consistent.
- **Output:** A structured JSON object containing an array of `{ paragraph: string, imagePrompt: string }`.
- **Configuration:**
  - `responseMimeType: 'application/json'`
  - `responseSchema`: A schema enforcing the JSON structure described above.

### Service: Generate Story Illustrations

- **Purpose:** Creates a unique illustration for each part of the story using the prompts generated by the previous service. This service is called in a loop, once for each story part.
- **File:** `src/services/geminiService.ts`
- **Function:** `generateStoryAndImages()` (second part)
- **Model:** `imagen-4.0-generate-001`
- **Prompt:** Consumes the `imagePrompt` string generated by the text model.
- **Output:** A base64-encoded image.
- **Configuration:**
  - `numberOfImages: 1`
  - `aspectRatio`: Dynamically set based on user's chosen story layout ('1:1', '16:9', or '3:4').
  - `outputMimeType: 'image/png'`

### Service: Generate Character Portrait

- **Purpose:** Creates a visual portrait for a character based on a user's textual description.
- **File:** `src/services/geminiService.ts`
- **Function:** `generateCharacterImage()`
- **Model:** `imagen-4.0-generate-001`
- **Prompt:** A template that wraps the user's description, asking for a `Portrait of a storybook character` in a `whimsical, friendly, children's book illustration` style.
- **Output:** A base64-encoded image.
- **Configuration:**
  - `numberOfImages: 1`
  - `aspectRatio: '1:1'`
  - `outputMimeType: 'image/png'`

### Service: Voice-to-Character

- **Purpose:** Transcribes a user's spoken description of a character and structures the output into a name and description.
- **File:** `src/services/geminiService.ts`
- **Function:** `transcribeAndStructureCharacterPrompt()`
- **Model:** `gemini-2.5-flash`
- **Prompt:** A multi-modal prompt containing the user's audio. The text instruction asks the model to transcribe the audio and extract (or invent) a `name` and a `description`.
- **Output:** A structured JSON object.
- **Configuration:**
  - `responseMimeType: 'application/json'`
  - `responseSchema`: An object schema enforcing the structure `{ name: string, description: string }`.

### Service: Voice-to-Story Idea

- **Purpose:** Transcribes a user's spoken story idea and structures it into the four key components required for story generation.
- **File:** `src/services/geminiService.ts`
- **Function:** `transcribeAndStructureStoryPrompt()`
- **Model:** `gemini-2.5-flash`
- **Prompt:** A multi-modal prompt containing the user's audio. The text instruction asks the model to transcribe the audio and extract `character`, `setting`, `plot`, and `concept`, inferring any missing parts.
- **Output:** A structured JSON object.
- **Configuration:**
  - `responseMimeType: 'application/json'`
  - `responseSchema`: An object schema enforcing the structure `{ character: string, setting: string, plot: string, concept: string }`.

### Service: AI Text-to-Speech (TTS)

- **Purpose:** Converts story text into high-quality, lifelike audio using a selection of premium voices.
- **Note:** This service is fully implemented in the backend but is currently disabled in the user-facing settings UI in favor of the standard browser TTS engine.
- **File:** `src/services/ttsService.ts`
- **Function:** `generateSpeech()`
- **Model:** `gemini-2.5-flash-preview-tts`
- **Prompt:** The text content of the story.
- **Output:** A stream of raw PCM audio data, which the service captures and wraps in a WAV header to create a playable `audio/wav` Blob.
- **Configuration:**
  - `responseModalities: ['audio']`
  - `speechConfig`: Specifies the `voiceName` from a predefined list of premium voices.